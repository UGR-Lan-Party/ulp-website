---
import type { SponsorData } from '../data/sponsors.ts';
import { secretSponsor } from '../data/sponsors.ts';
import SocialButton from './SocialButton.astro';
import { gsap } from 'gsap';
import { ScrambleTextPlugin } from 'gsap/ScrambleTextPlugin';
import { SplitText } from 'gsap/SplitText';
import { TextPlugin } from 'gsap/TextPlugin';

gsap.registerPlugin(ScrambleTextPlugin, SplitText, TextPlugin);

interface Props {
  sponsor: SponsorData;
}

let { sponsor } = Astro.props as Props;

if (sponsor.isSecret) {
  sponsor = secretSponsor[0];
}

const colors: Record<string, string> = {
  platinum: '[#1771E6]',
  gold: '[#FFC002]',
  silver: '[#9a9ba0]',
  bronze: '[#BB5522]',
};

const diamondColors: Record<string, string> = {
  'T-Systems Iberia': '[#E30075]',
  'Gen.G Global Academy': '[#f2ca18]',
  'SIDN Digital Thinking': '[#EC602C]',
};

const getTierColor = (tier: string, name: string) => {
  if (sponsor.isSecret) {
    return colors['gold'] || '';
  }
  if (tier === 'diamond') {
    return diamondColors[name] || '';
  }
  return colors[tier] || '';
};

const tierColor = getTierColor(sponsor.tier, sponsor.name);
const tierColorHex = tierColor.replace(/^\[|\]$/g, '');
const patternId = `bg_pattern_${sponsor.name
  .toLowerCase()
  .replace(/[^a-z0-9]+/g, '_')
  .replace(/^_+|_+$/g, '')}`;

const sponsorName = sponsor.name;

// Separar descripción en palabras para el DOM
const descriptionWords = sponsor.description.split(' ');
---

<section
  id="sponsor-card"
  class={`sponsor-card-${patternId} w-[444px] h-[677px] relative scale-[90%] md:scale-100`}
>
  <!-- ── SVG principal de la carta ─────────────────────────────── -->
  <svg
    class="absolute z-0 top-0 left-0"
    id="sponsor-card-shape"
    xmlns="http://www.w3.org/2000/svg"
    width="444"
    height="677"
    viewBox="0 0 444 677"
    fill="none"
  >
    <defs>
      <filter
        id="filter0_d_30_615"
        x="0"
        y="0"
        width="444"
        height="677"
        filterUnits="userSpaceOnUse"
      >
        <feGaussianBlur stdDeviation="2"></feGaussianBlur>
        <feOffset dy="4"></feOffset>
        <feColorMatrix
          type="matrix"
          values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"></feColorMatrix>
        <feBlend mode="normal" in="SourceGraphic"></feBlend>
      </filter>

      <pattern
        id={patternId}
        patternUnits="userSpaceOnUse"
        width="444"
        height="677"
      >
        <rect width="444" height="677" fill="#000000"></rect>
        <image
          href={sponsor.cardBg}
          x="0"
          y="0"
          width="444"
          height="677"
          preserveAspectRatio="xMidYMid slice"
          class="blur-sm opacity-20"
        />
      </pattern>
    </defs>

    <g filter="url(#filter0_d_30_615)">
      <path
        d="M438.035 76.1602V580.16C438.035 580.16 437.535 604.16 429.035 617.66C420.535 631.16 390.535 634.16 390.535 634.16C390.535 634.16 329.535 631.66 291.035 640.66C252.535 649.66 222.535 667.16 222.535 667.16C222.535 667.16 198 649.66 154.035 640.66C110.07 631.66 52.5349 634.16 52.5349 634.16C52.5349 634.16 24.1318 628.964 14.0349 617.66C3.93803 606.357 5.03495 580.16 5.03495 580.16V76.1602C5.03495 76.1602 42.1119 71.1602 85.0349 41.1602C127.958 11.1602 171.035 11.1602 171.035 11.1602C171.035 11.1602 182.987 25.6535 193.535 26.1602C204.083 26.6668 221.035 1.66016 221.035 1.66016C221.035 1.66016 242.728 27.6558 252.535 26.1602C262.342 24.6645 273.035 11.1602 273.035 11.1602C273.035 11.1602 326.535 11.1602 357.535 41.1602C388.535 71.1602 438.035 76.1602 438.035 76.1602Z"
        fill={`url(#${patternId})`}
        stroke="white"
        stroke-width="2"></path>
    </g>
  </svg>

  <!-- ── Contenido de la carta ─────────────────────────────────── -->
  <section
    id="sponsor-card-info"
    class="flex flex-col items-center w-full h-[80%] my-20 text-white relative z-10"
  >
    <picture
      class="w-[400px] h-[220px] rounded-2xl mt-2 relative overflow-hidden border border-white/20 backdrop-blur-lg"
    >
      <img
        alt="sponsor-logo"
        src={sponsor.logo}
        class="h-full w-full p-2 object-contain"
      />
    </picture>
    <section class="w-[400px] h-[250px] mt-4 flex flex-col items-center gap-1">
      <p class="font-bold text-3xl text-center" data-name={sponsorName}>
        {sponsorName}
      </p>
      <p
        class="font-semibold text-xl text-center"
        style={`color: ${tierColorHex};`}
      >
        {sponsor.bussiness}
      </p>

      <!-- Descripción animada: cada palabra en su propio span con blur -->
      <p id="gsap-sponsor-description" class="text-md text-center text-balance leading-relaxed">
        {descriptionWords.map((word, i) => (
          <span
            class="word-wrapper inline-block relative mx-[2px]"
            data-word={word}
            data-index={i}
          >
            <!-- Capa blur (visible por defecto) -->
            <span
              class="word-blur absolute inset-0 inline-block select-none pointer-events-none"
              aria-hidden="true"
              style="filter: blur(4px); backdrop-filter: blur(6px); background: rgba(255,255,255,0.08); border-radius: 3px; padding: 0 2px;"
            >
              {word}
            </span>
            <!-- Texto real (invisible por defecto, revelado con scramble) -->
            <span
              class="word-text inline-block opacity-0 px-[2px]"
              data-original={word}
            >
              {word}
            </span>
          </span>
        ))}
      </p>
    </section>

    <div
      class="w-full flex mb-2 items-center justify-center gap-8 absolute bottom-0"
    >
      {sponsor.links.map((link) => <SocialButton sponsorLink={link} />)}
    </div>
  </section>
</section>

<script>
  import { gsap } from 'gsap';
  import { ScrambleTextPlugin } from 'gsap/ScrambleTextPlugin';

  gsap.registerPlugin(ScrambleTextPlugin);

  document.querySelectorAll('[id^="sponsor-card"]').forEach((card) => {
    // Busca la sección contenedora más cercana con la clase sponsor-card-*
    const cardEl = card.closest
      ? card.closest('[class*="sponsor-card-"]') ?? card
      : card;

    let scrambleTl: gsap.core.Timeline | null = null;
    let isAnimating = false;

    const wordWrappers = card.querySelectorAll<HTMLElement>('.word-wrapper');

    const totalDuration = 5; // segundos totales para revelar todas las palabras
    const delayPerWord = wordWrappers.length > 1
      ? totalDuration / wordWrappers.length
      : totalDuration;

    function revealWords() {
      if (isAnimating) return;
      isAnimating = true;

      scrambleTl = gsap.timeline({
        onComplete: () => { isAnimating = false; },
      });

      wordWrappers.forEach((wrapper, i) => {
        const blurEl = wrapper.querySelector<HTMLElement>('.word-blur');
        const textEl = wrapper.querySelector<HTMLElement>('.word-text');
        if (!blurEl || !textEl) return;

        const original = textEl.dataset.original ?? textEl.textContent ?? '';
        const startTime = i * delayPerWord;
        const scrambleDuration = Math.max(0.6, delayPerWord * 1.2);

        // 1. Revelar el texto real y hacer scramble
        scrambleTl!.to(
          textEl,
          {
            duration: scrambleDuration,
            scrambleText: {
              text: original,
              chars: 'lowerCase',
              revealDelay: 0.1,
              speed: 0.6,
            },
            opacity: 1,
            ease: 'none',
          },
          startTime
        );

        // 2. Al mismo tiempo, disolver el blur
        scrambleTl!.to(
          blurEl,
          {
            duration: scrambleDuration * 0.6,
            filter: 'blur(0px)',
            opacity: 0,
            ease: 'power2.out',
          },
          startTime
        );
      });
    }

    function resetWords() {
      if (scrambleTl) {
        scrambleTl.kill();
        scrambleTl = null;
      }
      isAnimating = false;

      wordWrappers.forEach((wrapper) => {
        const blurEl = wrapper.querySelector<HTMLElement>('.word-blur');
        const textEl = wrapper.querySelector<HTMLElement>('.word-text');
        if (!blurEl || !textEl) return;

        gsap.set(blurEl, { filter: 'blur(6px)', opacity: 1 });
        gsap.set(textEl, { opacity: 0 });
        // Restaurar texto original por si scramble lo dejó a medias
        textEl.textContent = textEl.dataset.original ?? '';
      });
    }

    cardEl.addEventListener('mouseenter', revealWords);
    cardEl.addEventListener('mouseleave', resetWords);
  });
</script>